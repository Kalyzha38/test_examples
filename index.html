
<html>

<head>

    <title>Quick Start - Leaflet</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
          integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
            integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
            crossorigin=""></script>
    <script src="https://www.gstatic.com/firebasejs/7.8.0/firebase.js"></script>

</head>

<body>
<div id="map" style="height: 100%; width: 100%; display: block"></div>
</body>

<script type="text/javascript">

    var map = L.map('map').setView([50.4266541, 30.505516], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var trafficGreenLight = L.icon({
            iconUrl: 'http://www.mediafire.com/convkey/7802/5kao4fhnsjs6ej3zg.jpg',

            iconSize: [18, 18], // size of the icon
            iconAnchor: [9, 9], // point of the icon which will correspond to marker's locationr
        }),
        trafficRedLight = L.icon({
            iconUrl: 'http://www.mediafire.com/convkey/9c0e/zkjo440rz6s2y7rzg.jpg?size_id=2',

            iconSize: [18, 18], // size of the icon
            iconAnchor: [9, 9], // point of the icon which will correspond to marker's location
        });

    window.onload = function (e) {
        let xhr = new XMLHttpRequest();
        xhr.responseType = "json";
        xhr.open("POST", "https://lz4.overpass-api.de/api/interpreter");
        var request =
            '<osm-script output="json" output-config="" timeout="25">' +
            '<id-query type="area" ref="3600421866" into="searchArea"/>' +
            '<union>' +
            '<query type="node">' +
            '<has-kv k="highway" v="traffic_signals"/>' +
            '<area-query from="searchArea"/>' +
            '</query>' +
            '</union>' +
            '<print geometry="skeleton" ids="yes" mode="body" order="id"/>' +
            '<recurse type="down"/>' +
            '<print geometry="skeleton" ids="yes" mode="skeleton" order="quadtile"/>' +
            '</osm-script>';
        request = (new DOMParser).parseFromString(request, "text/xml");
        console.log(request);
        xhr.send(request);
        xhr.onload = () => {
            if (xhr.status == 200) {
                let data = xhr.response;
                console.log(data.osm3s.timestamp_osm_base);
                addMarkers(data);
            }
        }
    }

    function addMarkers(data) {
        var trafficLights = data.elements;

        trafficLights.forEach(element => {
            let state = Math.floor(Math.random() * 100);

            if (state % 2 == 0)
                var marker = L.marker([element.lat, element.lon], { icon: trafficGreenLight })
            else
                var marker = L.marker([element.lat, element.lon], { icon: trafficRedLight })
            marker.addTo(map).on('click', changeColor);
            marker.bindPopup("<b>Traffic light</b><br>#" + marker.getLatLng().toString());
            var counter = new Counter(marker, 6000);
            counter.start();
        });
    }

    function changeColor(e) {
        marker = e.target.getIcon();
        if (marker.options.iconUrl == trafficGreenLight.options.iconUrl)
            e.target.setIcon(trafficRedLight);
        else
            e.target.setIcon(trafficGreenLight);
    }

    function Counter(marker, delay) {
        var interval;

        function changeColor() {
            if (marker.options.icon.options.iconUrl == trafficGreenLight.options.iconUrl)
                marker.setIcon(trafficRedLight);
            else
                marker.setIcon(trafficGreenLight);
        }

        function run() {
            changeColor();
        }

        function start() {
            interval = window.setInterval(run, delay);
        }

        // exports
        // This actually creates a function that our counter can call
        // you'll see it used below.
        //
        // The other functions above cannot be accessed from outside
        // this function.
        this.start = start;
    }

    const firebaseConfig = {
        apiKey: "AIzaSyDdNXdOk_HRhZh-Stfg5qfeyPUT_xsKohM",
        authDomain: "green-waves.firebaseapp.com",
        databaseURL: "https://green-waves.firebaseio.com",
        projectId: "green-waves",
        storageBucket: "green-waves.appspot.com",
        messagingSenderId: "370245425380",
        appId: "1:370245425380:web:664b3ad6695b58b46ef4f1",
        measurementId: "G-QL2EC8GB7R"
    };

    firebase.initializeApp(firebaseConfig);

    let data = firebase.database().ref('devices');
    let child_list = [];

    data.on('value', function (snapshot) {
        // if ()
        for (mqtt in snapshot.val() ) {
            if (!(`${mqtt}` in child_list)) {
                data.child(`${mqtt}`).on('value', function (snapshot) {
                    console.log(`${mqtt}` + JSON.stringify(snapshot.val()));
                    child_list.push(`${mqtt}`)
                })
            } else{
                //pass
            }
        }
    });

    data.on('value', function (snapshot) {
        for (mqtt in snapshot.val() ) {
            data.child(`${mqtt}`).on('value', function (snapshot) {
                data.child('telemetry').on('value', function (snapshot) {
                    console.log('\n telemetry: \n' + JSON.stringify(snapshot.val()));
                })
            })
        }
    });
</script>

</html>
